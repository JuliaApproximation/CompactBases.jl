# Diagonal operators

Diagonal operators are operators (functionals) that only depend on the
coordinate; they are also called local operators. They act on a
function to produce a new function as

```math
L f(x) = f(x)g(x)
```

Typical examples are potentials, such as the Coulomb potential ``V(x)
= Q/x``, generated by a charge ``Q``. This potential is not
polynomial, i.e. we cannot compute its matrix elements exactly using
Gauß quadratures, but with high enough order and intelligent placement
of the nodes, we can get sufficient accuracy.

In orthogonal bases, such as finite-differences and FE-DVR diagonal
operators are represented by diagonal matrices, whose elements
coincide with the values of the function evaluated at the nodes,
whereas in B-splines they are banded (with the bandwidth decided by
the polynomial order).

We can construct diagonal operators in two ways:

1. From a scalar-valued function
2. From a vector of expansion coefficients

## Construction from scalar-valued function

The first way consists of constructing a `QuasiDiagonal` object
representing the function broadcast along the continuous dimension of
our quasimatrix:

```jldoctest
julia> f = x -> sin(2π*x);

julia> rmax,k,N = 10.0,7,71;

julia> r = Inclusion(0..rmax)
Inclusion(0.0..10.0)

julia> qf = QuasiDiagonal(f.(r))
QuasiDiagonal{Float64,QuasiArrays.BroadcastQuasiArray{Float64,1,var"#3824#3825",Tuple{Inclusion{Float64,IntervalSets.Interval{:closed,:closed,Float64}}}}}(QuasiArrays.BroadcastQuasiArray{Float64,1,var"#3824#3825",Tuple{Inclusion{Float64,IntervalSets.Interval{:closed,:closed,Float64}}}}(var"#3824#3825"(), (Inclusion(0.0..10.0),)))
```

We can then project this onto a specific basis:

```jldoctest
julia> R = FiniteDifferences(1:N, rmax/(N+1))
Finite differences basis {Float64} on 0.0..10.0 with 71 points spaced by Δx = 0.1388888888888889

julia> F = R'*qf*R
71×71 Diagonal{Float64,Array{Float64,1}}:
 0.766044   ⋅         ⋅     ⋅         ⋅          ⋅          ⋅        …   ⋅         ⋅         ⋅         ⋅         ⋅     ⋅          ⋅
  ⋅        0.984808   ⋅     ⋅         ⋅          ⋅          ⋅            ⋅         ⋅         ⋅         ⋅         ⋅     ⋅          ⋅
  ⋅         ⋅        0.5    ⋅         ⋅          ⋅          ⋅            ⋅         ⋅         ⋅         ⋅         ⋅     ⋅          ⋅
  ⋅         ⋅         ⋅   -0.34202    ⋅          ⋅          ⋅            ⋅         ⋅         ⋅         ⋅         ⋅     ⋅          ⋅
  ⋅         ⋅         ⋅     ⋅       -0.939693    ⋅          ⋅            ⋅         ⋅         ⋅         ⋅         ⋅     ⋅          ⋅
  ⋅         ⋅         ⋅     ⋅         ⋅        -0.866025    ⋅        …   ⋅         ⋅         ⋅         ⋅         ⋅     ⋅          ⋅
  ⋅         ⋅         ⋅     ⋅         ⋅          ⋅        -0.173648      ⋅         ⋅         ⋅         ⋅         ⋅     ⋅          ⋅
  ⋅         ⋅         ⋅     ⋅         ⋅          ⋅          ⋅            ⋅         ⋅         ⋅         ⋅         ⋅     ⋅          ⋅
  ⋅         ⋅         ⋅     ⋅         ⋅          ⋅          ⋅            ⋅         ⋅         ⋅         ⋅         ⋅     ⋅          ⋅
  ⋅         ⋅         ⋅     ⋅         ⋅          ⋅          ⋅            ⋅         ⋅         ⋅         ⋅         ⋅     ⋅          ⋅
  ⋅         ⋅         ⋅     ⋅         ⋅          ⋅          ⋅        …   ⋅         ⋅         ⋅         ⋅         ⋅     ⋅          ⋅
  ⋅         ⋅         ⋅     ⋅         ⋅          ⋅          ⋅            ⋅         ⋅         ⋅         ⋅         ⋅     ⋅          ⋅
  ⋅         ⋅         ⋅     ⋅         ⋅          ⋅          ⋅            ⋅         ⋅         ⋅         ⋅         ⋅     ⋅          ⋅
  ⋅         ⋅         ⋅     ⋅         ⋅          ⋅          ⋅            ⋅         ⋅         ⋅         ⋅         ⋅     ⋅          ⋅
  ⋅         ⋅         ⋅     ⋅         ⋅          ⋅          ⋅            ⋅         ⋅         ⋅         ⋅         ⋅     ⋅          ⋅
  ⋅         ⋅         ⋅     ⋅         ⋅          ⋅          ⋅        …   ⋅         ⋅         ⋅         ⋅         ⋅     ⋅          ⋅
 ⋮                                              ⋮                    ⋱            ⋮                                              ⋮
  ⋅         ⋅         ⋅     ⋅         ⋅          ⋅          ⋅        …   ⋅         ⋅         ⋅         ⋅         ⋅     ⋅          ⋅
  ⋅         ⋅         ⋅     ⋅         ⋅          ⋅          ⋅            ⋅         ⋅         ⋅         ⋅         ⋅     ⋅          ⋅
  ⋅         ⋅         ⋅     ⋅         ⋅          ⋅          ⋅            ⋅         ⋅         ⋅         ⋅         ⋅     ⋅          ⋅
  ⋅         ⋅         ⋅     ⋅         ⋅          ⋅          ⋅            ⋅         ⋅         ⋅         ⋅         ⋅     ⋅          ⋅
  ⋅         ⋅         ⋅     ⋅         ⋅          ⋅          ⋅            ⋅         ⋅         ⋅         ⋅         ⋅     ⋅          ⋅
  ⋅         ⋅         ⋅     ⋅         ⋅          ⋅          ⋅        …   ⋅         ⋅         ⋅         ⋅         ⋅     ⋅          ⋅
  ⋅         ⋅         ⋅     ⋅         ⋅          ⋅          ⋅            ⋅         ⋅         ⋅         ⋅         ⋅     ⋅          ⋅
  ⋅         ⋅         ⋅     ⋅         ⋅          ⋅          ⋅            ⋅         ⋅         ⋅         ⋅         ⋅     ⋅          ⋅
  ⋅         ⋅         ⋅     ⋅         ⋅          ⋅          ⋅            ⋅         ⋅         ⋅         ⋅         ⋅     ⋅          ⋅
  ⋅         ⋅         ⋅     ⋅         ⋅          ⋅          ⋅           0.173648   ⋅         ⋅         ⋅         ⋅     ⋅          ⋅
  ⋅         ⋅         ⋅     ⋅         ⋅          ⋅          ⋅        …   ⋅        0.866025   ⋅         ⋅         ⋅     ⋅          ⋅
  ⋅         ⋅         ⋅     ⋅         ⋅          ⋅          ⋅            ⋅         ⋅        0.939693   ⋅         ⋅     ⋅          ⋅
  ⋅         ⋅         ⋅     ⋅         ⋅          ⋅          ⋅            ⋅         ⋅         ⋅        0.34202    ⋅     ⋅          ⋅
  ⋅         ⋅         ⋅     ⋅         ⋅          ⋅          ⋅            ⋅         ⋅         ⋅         ⋅       -0.5    ⋅          ⋅
  ⋅         ⋅         ⋅     ⋅         ⋅          ⋅          ⋅            ⋅         ⋅         ⋅         ⋅         ⋅   -0.984808    ⋅
  ⋅         ⋅         ⋅     ⋅         ⋅          ⋅          ⋅        …   ⋅         ⋅         ⋅         ⋅         ⋅     ⋅        -0.766044
```

As indicated above, for uniform finite-differences the matrix elements
coincide with the function values at the nodes:

```jldoctest
julia> norm(diag(F) - f.(CompactBases.locs(R)))
0.0
```

For B-splines, the situation is complicated by the fact that the basis
functions are non-orthogonal:

```jldoctest
julia> R = BSpline(LinearKnotSet(k, 0, rmax, N))
BSpline{Float64} basis with LinearKnotSet(Float64) of order k = 7 on 0.0..10.0 (71 intervals)

julia> F = R'*qf*R
77×77 BandedMatrices.BandedMatrix{Float64,Array{Float64,2},Base.OneTo{Int64}}:
 0.000682615  0.000987306  0.00043971   8.7846e-5    8.60727e-6    3.99159e-7   …    ⋅            ⋅             ⋅             ⋅
 0.000987306  0.00413625   0.00468984   0.00232941   0.000573453   6.82737e-5        ⋅            ⋅             ⋅             ⋅
 0.00043971   0.00468984   0.0114273    0.0114915    0.00562534    0.00134742        ⋅            ⋅             ⋅             ⋅
 8.7846e-5    0.00232941   0.0114915    0.021737     0.0194201     0.00849555        ⋅            ⋅             ⋅             ⋅
 8.60727e-6   0.000573453  0.00562534   0.0194201    0.0303017     0.0226904         ⋅            ⋅             ⋅             ⋅
 3.99159e-7   6.82737e-5   0.00134742   0.00849555   0.0226904     0.0273211    …    ⋅            ⋅             ⋅             ⋅
 6.92763e-9   3.1258e-6    0.000131733  0.0016054    0.0074447     0.0129012         ⋅            ⋅             ⋅             ⋅
  ⋅           4.90703e-10  7.84375e-7   4.68188e-5   0.000508687   0.000296132       ⋅            ⋅             ⋅             ⋅
  ⋅            ⋅           8.00117e-11  1.57973e-7   1.60126e-6   -0.000368678       ⋅            ⋅             ⋅             ⋅
  ⋅            ⋅            ⋅           1.8637e-12  -8.38672e-8   -2.36173e-5        ⋅            ⋅             ⋅             ⋅
  ⋅            ⋅            ⋅            ⋅          -2.00923e-11  -1.72818e-7   …    ⋅            ⋅             ⋅             ⋅
  ⋅            ⋅            ⋅            ⋅            ⋅           -2.22022e-11       ⋅            ⋅             ⋅             ⋅
  ⋅            ⋅            ⋅            ⋅            ⋅             ⋅                ⋅            ⋅             ⋅             ⋅
  ⋅            ⋅            ⋅            ⋅            ⋅             ⋅                ⋅            ⋅             ⋅             ⋅
  ⋅            ⋅            ⋅            ⋅            ⋅             ⋅                ⋅            ⋅             ⋅             ⋅
  ⋅            ⋅            ⋅            ⋅            ⋅             ⋅           …    ⋅            ⋅             ⋅             ⋅
 ⋮                                                                 ⋮            ⋱                              ⋮
  ⋅            ⋅            ⋅            ⋅            ⋅             ⋅                ⋅            ⋅             ⋅             ⋅
  ⋅            ⋅            ⋅            ⋅            ⋅             ⋅                ⋅            ⋅             ⋅             ⋅
  ⋅            ⋅            ⋅            ⋅            ⋅             ⋅                ⋅            ⋅             ⋅             ⋅
  ⋅            ⋅            ⋅            ⋅            ⋅             ⋅                ⋅            ⋅             ⋅             ⋅
  ⋅            ⋅            ⋅            ⋅            ⋅             ⋅           …    ⋅            ⋅             ⋅             ⋅
  ⋅            ⋅            ⋅            ⋅            ⋅             ⋅                ⋅            ⋅             ⋅             ⋅
  ⋅            ⋅            ⋅            ⋅            ⋅             ⋅              -1.8637e-12    ⋅             ⋅             ⋅
  ⋅            ⋅            ⋅            ⋅            ⋅             ⋅              -1.57973e-7  -8.00117e-11    ⋅             ⋅
  ⋅            ⋅            ⋅            ⋅            ⋅             ⋅              -4.68188e-5  -7.84375e-7   -4.90703e-10    ⋅
  ⋅            ⋅            ⋅            ⋅            ⋅             ⋅           …  -0.0016054   -0.000131733  -3.1258e-6    -6.92763e-9
  ⋅            ⋅            ⋅            ⋅            ⋅             ⋅              -0.00849555  -0.00134742   -6.82737e-5   -3.99159e-7
  ⋅            ⋅            ⋅            ⋅            ⋅             ⋅              -0.0194201   -0.00562534   -0.000573453  -8.60727e-6
  ⋅            ⋅            ⋅            ⋅            ⋅             ⋅              -0.021737    -0.0114915    -0.00232941   -8.7846e-5
  ⋅            ⋅            ⋅            ⋅            ⋅             ⋅              -0.0114915   -0.0114273    -0.00468984   -0.00043971
  ⋅            ⋅            ⋅            ⋅            ⋅             ⋅           …  -0.00232941  -0.00468984   -0.00413625   -0.000987306
  ⋅            ⋅            ⋅            ⋅            ⋅             ⋅              -8.7846e-5   -0.00043971   -0.000987306  -0.000682615
```

## Construction from existing expansion coefficients

Now, assume that we already know ``f(x)`` expanded over the basis
function ``B_i(x)`` of our basis:

```math
f(x) = \sum_i f_i B_i(x)
\iff
\ket{f} = \sum_i f_i \ket{B_i}
\iff
\ket{f} = B\vec{f}
```

where

```math
B \defd
\bmat{\ket{B_{1}} & \ket{B_{2}} & \dots & \ket{B_{n}}}.
```

We wish to find the matrix elements of the matrix representing the
linear functional that acting on ``1`` gives ``f(x)``:

```math
\operator{L}1 = f(x),
```

i.e. we are in some sense trying to solve

```math
\mat{L}\vec{o} = \vec{f}
```

for ``\mat{L}``, where ``\vec{o}`` is the expansion coefficients of
``1`` in our basis.

The most straightforward way is via the Vandermonde matrix ``V``

```math
f(\vec{x}) = \mat{V}\vec{f}
```

where ``\vec{x}`` the vector of interpolation points (quadrature
nodes). The matrix elements of the linear operator are then simply
computed by quadrature

```math
\mat{L}_{mn} = \matrixel{B_m}{f(\vec{x})}{B_n}
```

For the orthogonal bases, where ``B_m(x_k)=\delta_{mk}``, this matrix
reduces to

```math
\mat{L}_{mn} = \delta_{mn}f(x_m),
```

as noted above.

### Example

As an example, we consider the calculation of

```math
g(r) = \operator{L}f(r),
```
where ``f(r)=r`` and
```math
\begin{aligned}
\operator{L} &= V(r) =
(\alpha r^2 + \beta r)
\exp(-3r/2),
&
\begin{cases}
\alpha&\approx0.314269680527354,\\
\beta&\approx0.20951312035157,
\end{cases}
\end{aligned}
```
which is a kind of potential that arises in Coulomb repulsion between
two electrons.

Now assume we know the expansion coefficients of ``V(x)`` _as a
function_ in a certain basis, and we wish to turn it into _a matrix_
that we can act on vectors of expansion coefficients of other
functions. We can find this matrix using the helper object
[`DiagonalOperator`](@ref), which takes a vector of expansion
coefficients and applies the Vandermonde matrix as outlined
above. Additionally, it supports updating the matrix from a new set of
expansion coefficients via `copyto!(::DiagonalOperator,
::AbstractVector)`; this is useful if the vector of coefficients are
updated in an iterative procedure.

As noted in [Solving equations](@ref), when applying a matrix
representation onto a vector of expansion coefficients, for
non-orthogonal bases (and non-uniform finite-differences), we need to
also apply the inverse of the metric (accessible for this case through
[`CompactBases.operator_metric`](@ref)). This can be automated however
using [`LinearOperator`](@ref), which will apply the metric when
necessary.

Using these two helper objects, it is very easy to construct the
linear operator corresponding to ``V(r)``:

```jldoctest
julia> Z = 1.0
1.0

julia> rmax = 20*(2^1.05)/Z
41.4105969536551

julia> R = BSpline(ExpKnotSet(5, -2.0, log10(rmax), 100))[:,2:end-1]
BSpline{Float64} basis with ExpKnotSet(Float64) of order k = 5 (quartic) on 0,0.01..41.4105969536551 (100 intervals), restricted to basis functions 2..103 ⊂ 1..104

julia> r = axes(R,1)
Inclusion(0.0..41.4105969536551)

julia> V = r -> (0.314269680527354*r^2 + 0.20951312035157*r)*exp(-3*r/2);

julia> Vc = R \ V.(r);

julia> rc = R \ identity.(r);

julia> L = DiagonalOperator(applied(*, R, Vc));

julia> Lop = LinearOperator(L, R);

julia> Vr = Lop*rc
102-element Array{Float64,1}:
 -6.437293442739495e-13
  3.798365453775743e-6
  1.2424470533333464e-5
  2.7121761289132286e-5
  3.2090730029882946e-5
  3.796988258561289e-5
  4.492587091937226e-5
  5.315583051008927e-5
  6.289294839226428e-5
  7.441303882230927e-5
  8.804231534677851e-5
  0.00010416656971041078
  0.0001232420118403251
  0.00014580806529367152
  0.00017250246558852265
  0.0002040790666006322
  ⋮
  4.161019867703719e-6
  1.0650428611646796e-6
  1.6261694973586933e-7
  5.6081547869892246e-8
 -8.301480628382248e-9
  8.10282119124874e-9
 -4.356767898816949e-9
  2.566986109249515e-9
 -1.4952235572648308e-9
  8.77464781994956e-10
 -5.23100919774441e-10
  3.250499162326124e-10
 -2.2378205999333905e-10
  1.932597252925329e-10
 -1.2790533015167562e-10
  5.54754760432595e-11
```

![Diagonal operators](figures/diagonal_operators.svg)
